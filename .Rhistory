rm(list=ls())
url <- function(address, return.call = "json", sensor = "false") {
root <- "https://maps.googleapis.com/maps/api/geocode/"
u <- paste(root, return.call, "?address=", address, "&sensor=", sensor, sep = "")
return(URLencode(u))
}
geoCode <- function(address,verbose=FALSE) {
if(verbose) cat(address,"\n")
u <- url(address)
doc <- getURL(u)
x <- fromJSON(doc,simplify = FALSE)
if(x$status=="OK") {
lat <- x$results[[1]]$geometry$location$lat
lng <- x$results[[1]]$geometry$location$lng
location_type <- x$results[[1]]$geometry$location_type
formatted_address <- x$results[[1]]$formatted_address
return(c(lat, lng, location_type, formatted_address))
Sys.sleep(0.5)
} else {
return(c(NA,NA,NA,NA))
}
}
# Use plyr to ggeocoding for a vector
address <- c("The White House, Washington, DC", "The Capitol, Washington, DC")
locations <- ldply(address, function(x) geoCode(x))
names(locations) <- c("lat", "lon", "location_type", "formatted")
head(locations)
address
#INEGI mapa
# mex2 <- st_read("Shapefiles/MEX_adm2.shp",quiet=T,stringsAsFactors = F)
# mex2 <- subset(mex2, mex2$ID_1==31)
# # st_bbox(mex2[1,])#get bbox of first line
# length(unique(urbana2$nombre))#340 loclaities
#has good locality names
addresses2 <- read.csv("Linux Data/addresses2_mod2.csv",header=T,stringsAsFactors = F)
setwd(paste0(rootdir,"U-of-Florida-Yucatan-Project/"))
rootdir="C:/Users/Silvio/Documents/GitHub/"
rootdir1="C:/Users/Silvio/Documents/"
setwd(paste0(rootdir,"U-of-Florida-Yucatan-Project/"))
mapdir="ArcGIS Explorer/My Basemaps/MEX_adm/"
mapdir1="ArcGIS Explorer/My Basemaps/encuesta_intercensal_2015 Diego/encuesta_intercensal_2015/shps/yuc/"
mapdir2="ArcGIS Explorer/My Basemaps/INEGI mapa/conjunto_de_datos/"
library(cartography)
library(sf)
library(sp)
library(rgdal)
library(dplyr)
#INEGI mapa
# mex2 <- st_read("Shapefiles/MEX_adm2.shp",quiet=T,stringsAsFactors = F)
# mex2 <- subset(mex2, mex2$ID_1==31)
# # st_bbox(mex2[1,])#get bbox of first line
# length(unique(urbana2$nombre))#340 loclaities
#has good locality names
addresses2 <- read.csv("Linux Data/addresses2_mod2.csv",header=T,stringsAsFactors = F)
rural<-st_read(paste0(rootdir1,mapdir1,"yuc_ageb_rural.shp"),quiet=T,stringsAsFactors = F)#Encuesta intercensal
rural$CVE_MUN <- as.numeric(rural$CVE_MUN)
rural$CVE_ENT <- as.numeric(rural$CVE_ENT)
urbana2 <- st_read("Shapefiles/INEGI mapa/localidad250_a.shp",quiet=T,stringsAsFactors = F)
urbana2$nombre<- iconv(urbana2$nombre,from="UTF-8",to="ASCII//TRANSLIT")
urbana2 <- st_transform(urbana2,crs=4326)##Converting coordinates from NAD83 to WGS84
municipios<- read.csv("catalogo de municipios_mod.csv",header=T,stringsAsFactors = F);View(municipios)
municipios$Nombre.del.Municipio <- toupper(municipios$Nombre.del.Municipio)
#new modified addresses with hits from Linux
####
addresses2_hits <-read.csv("Linux Data/addresses2_mod2_hits.csv",header=T,stringsAsFactors = F)#;View(addresses2_hits)
addresses2==addresses2_hits
View(addresses2)
#Creating vector of localities from addresses2 that are in urbana2
urbana2_hits=NULL
for (i in seq(addresses2$LOCALIDAD)){
if (addresses2$LOCALIDAD[i] %in% urbana2$nombre==T ){#if the address is not in urbana2 (==FALSE)
urbana2_hits[i]=addresses2$LOCALIDAD[i]
}
else if (addresses2$LOCALIDAD[i] %in% urbana2$nombre){
next
}
}
urbana2_hits <- (which(!is.na(urbana2_hits)))
#new modified addresses with hits from Linux
####
addresses2_hits <-read.csv("Linux Data/addresses2_mod2_hits.csv",header=T,stringsAsFactors = F)#;View(addresses2_hits)
for (i in seq(length(addresses2_hits$HITS))){
if ((i %in% urbana2_hits && grepl("ZERO_RESULTS",addresses2_hits$HITS[i]))==T){
addresses2_hits$HITS[i] <- "locality matches!" #phrase: "locality matches!"
}
}
##TO COUNT HOW MANY additional SCHOOL HITS for municipalities (just those left over)
for (i in seq(length(addresses2_hits$HITS))){
if ((grepl("ZERO_RESULTS",addresses2_hits$HITS[i]))==T){
addresses2_hits$HITS[i] <- "municipality matches!" #phrase: "municipality matches!"
}
}
View(addresses2_hits)
length(which(addresses2_hits$HITS=="locality matches!"))#998 additional hits! (urbana2)
length(which(addresses2_hits$HITS=="locality matches!"))#951 add hits! (urbana4)
#######
###############################################################################################
length(which(grepl("ZERO_RESULTS",addresses2_hits$HITS)==T))
length(which(grepl("OK",addresses2_hits$HITS)==T))#2101
length(which(grepl("municipality",addresses2_hits$HITS)==T))#191
length(which(grepl("locality",addresses2_hits$HITS)==T))#989
